{"version":3,"sources":["binding/base-binding.ts"],"names":[],"mappings":";AAGA,uBAAqB,WAAW,CAAC,CAAA;AAIjC,qBAAqB,MAAM,CAAC,CAAA;AAU5B;IAgCC,qBAAY,MAAY,EAAE,KAAyB;QAClD,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;IACtB,CAAC;IAhBD,sBAAI,iCAAQ;QALZ;;;;WAIG;aACH;YACC,MAAM,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC;QACrB,CAAC;;;OAAA;IAoBD,sBAAI,sCAAa;QAJjB;;;WAGG;aACH;YACC,MAAM,CAAC,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC;QACtB,CAAC;;;OAAA;IAES,iCAAW,GAArB,UAAsB,MAAY;QAAlC,iBAeC;QAdA,aAAM,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QACpB,aAAM,CAAC,OAAO,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;QAClC,aAAM,CAAC,OAAO,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;QAElC,IAAA,SAAkC,EAA7B,kBAAM,EAAE,gCAAa,CAAS;QACnC,EAAE,CAAC,CAAC,aAAa,CAAC,CAAC,CAAC;YACnB,MAAM,eAAM,CAAC,YAAY,EAAE,CAAC;QAC7B,CAAC;QACD,IAAI,CAAC,SAAS,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;QAC7B,6CAA6C;QAC5C,IAAY,CAAC,MAAM,GAAG,MAAM,CAAC;QAE9B,IAAI,CAAC,YAAY,GAAG,MAAM,CAAC,OAAO,CAAC,EAAE,CAAC,UAAA,IAAI,IAAI,OAAA,KAAI,CAAC,SAAS,CAAC,IAAI,EAAE,MAAM,CAAC,EAA5B,CAA4B,CAAC,CAAC;QAC5E,IAAI,CAAC,YAAY,GAAG,MAAM,CAAC,OAAO,CAAC,EAAE,CAAC,UAAA,IAAI,IAAI,OAAA,KAAI,CAAC,SAAS,CAAC,IAAI,EAAE,MAAM,CAAC,EAA5B,CAA4B,CAAC,CAAC;IAC7E,CAAC;IAEO,+BAAS,GAAjB,UAAkB,IAAa,EAAE,QAAc;QAC9C,IAAA,SAAsE,EAAjE,kBAAM,EAAE,kBAAM,EAAE,gCAAa,EAAE,8BAAY,EAAE,8BAAY,CAAS;QACvE,EAAE,CAAC,CAAC,CAAC,aAAa,CAAC,CAAC,CAAC;YACpB,MAAM,CAAC;QACR,CAAC;QACD,CAAC,YAAY,EAAE,YAAY,CAAC,CAAC,OAAO,CAAC,UAAA,CAAC,IAAI,OAAA,CAAC,CAAC,MAAM,EAAE,EAAV,CAAU,CAAC,CAAC;QACtD,IAAI,CAAC;YACJ,IAAI,CAAC,QAAQ,CAAC,QAAQ,KAAK,MAAM,GAAG,QAAQ,GAAG,QAAQ,EAAE,IAAI,CAAC,CAAC;QAChE,CAAC;gBACO,CAAC;YACR,CAAC,YAAY,EAAE,YAAY,CAAC,CAAC,OAAO,CAAC,UAAA,CAAC,IAAI,OAAA,CAAC,CAAC,QAAQ,EAAE,EAAZ,CAAY,CAAC,CAAC;QACzD,CAAC;IACF,CAAC;IAID,2BAAK,GAAL;QAEC,IAAA,SAAwD,EAAnD,8BAAY,EAAE,8BAAY,EAAE,kBAAM,EAAE,sBAAQ,CAAQ;QACzD,EAAE,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC;YACd,MAAM,CAAC;QACR,CAAC;QACD,aAAM,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC;QAC5B,YAAY,CAAC,KAAK,EAAE,CAAC;QACrB,YAAY,IAAI,YAAY,CAAC,KAAK,EAAE,CAAC;IACtC,CAAC;IACF,kBAAC;AAAD,CAvFA,AAuFC,IAAA;AAvFqB,mBAAW,cAuFhC,CAAA","file":"binding/base-binding.js","sourcesContent":["import {Subscription} from \"../events/subscription\";\r\nimport {RexScalar, ScalarChange} from \"../rexes/scalar/index\";\r\nimport {ReflectHelper} from '../reflection';\r\nimport {Errors} from '../errors';\r\nimport {readonly} from 'core-decorators';\r\nimport {Rex} from \"../rexes/base\";\r\nimport {BindingAttributes} from \"./index\";\r\nimport {assert} from \"chai\";\r\n\r\n\r\n/**\r\n * Created by Greg on 16/10/2016.\r\n */\r\n\r\n\r\nexport type BindPriority = \"origin\" | \"target\";\r\nexport type ChangeSource = \"origin\" | \"target\";\r\nexport abstract class BaseBinding<TChange, TRex extends Rex<TChange>> {\r\n\r\n\t/**\r\n\t * Subscription to the origin's notifier.\r\n\t * @private\r\n\t */\r\n\tprivate _originToken: Subscription;\r\n\t/**\r\n\t * Subscription to the target's notifier.\r\n\t * @private\r\n\t */\r\n\tprivate _targetToken: Subscription;\r\n\r\n\t/**\r\n\t * Whether the binding has been disposed.\r\n\t * @type {boolean}\r\n\t * @readonly\r\n\t */\r\n\tget isClosed() {\r\n\t\treturn !this.origin;\r\n\t}\r\n\t/**\r\n\t * The origin of the binding.\r\n\t * @readonly\r\n\t */\r\n\treadonly origin: TRex;\r\n\t/**\r\n\t * The target of the binding.\r\n\t * @readonly\r\n\t */\r\n\treadonly target: TRex;\r\n\r\n\tconstructor(origin: TRex, attrs : BindingAttributes) {\r\n\t\tthis.origin = origin;\r\n\t}\r\n\r\n\t/**\r\n\t * Returns true if the binding has been initialized, i.e. if it has been assigned a target.\r\n\t * @returns {boolean}\r\n\t */\r\n\tget isInitialized() {\r\n\t\treturn !!this.target;\r\n\t}\r\n\r\n\tprotected _initialize(target: TRex) : void {\r\n\t\tassert.isOk(target);\r\n\t\tassert.isNotOk(this._targetToken);\r\n\t\tassert.isNotOk(this._originToken);\r\n\r\n\t\tlet {origin, isInitialized} = this;\r\n\t\tif (isInitialized) {\r\n\t\t\tthrow Errors.alreadyBound();\r\n\t\t}\r\n\t\tthis._onChange(null, origin);\r\n\t\t//force-assign to this fake readonly property\r\n\t\t(this as any).target = target;\r\n\r\n\t\tthis._targetToken = target.changed.on(data => this._onChange(data, target));\r\n\t\tthis._originToken = origin.changed.on(data => this._onChange(data, origin));\r\n\t}\r\n\r\n\tprivate _onChange(data: TChange, notifier: TRex) : void {\r\n\t\tlet {origin, target, isInitialized, _targetToken, _originToken} = this;\r\n\t\tif (!isInitialized) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t[_targetToken, _originToken].forEach(x => x.freeze());\r\n\t\ttry {\r\n\t\t\tthis._rectify(notifier === origin ? \"origin\" : \"target\", data);\r\n\t\t}\r\n\t\tfinally {\r\n\t\t\t[_targetToken, _originToken].forEach(x => x.unfreeze());\r\n\t\t}\r\n\t}\r\n\r\n\tprotected abstract _rectify(source : ChangeSource, data : TChange);\r\n\r\n\tclose() {\r\n\r\n\t\tlet {_targetToken, _originToken, target, isClosed}= this;\r\n\t\tif (isClosed) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tassert.isTrue(_originToken);\r\n\t\t_originToken.close();\r\n\t\t_targetToken && _targetToken.close();\r\n\t}\r\n}"],"sourceRoot":"/src"}